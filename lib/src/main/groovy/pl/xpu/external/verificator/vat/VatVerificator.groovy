/*
 * This Groovy source file was generated by the Gradle 'init' task.
 */
package pl.xpu.external.verificator.vat

import groovy.json.JsonException
import groovy.json.JsonSlurper
import org.apache.logging.log4j.LogManager
import org.apache.logging.log4j.Logger


class VatVerificator {

    protected static final Logger log = LogManager.getLogger();

    static Boolean verify(String nip) {
        if(!nip){
            log.warn("Missing NIP argument")
            throw new IllegalArgumentException("Please provide valid NIP")
        }
        if(nip.size() != 10 ){
            log.warn("Wrong size of NIP argument")
            throw new IllegalArgumentException("Please provide valid NIP. It should be a number with 10 chars")
        }
        try{
            String response = GovConnector.getResponse(nip)
            def output = new JsonSlurper().parseText(response )
            log.debug "Output from response:" + output
            if(output?.result?.subject?.statusVat == "Czynny") {
                return true
            }
            return false
        } catch (JsonException ex){
            log.error("Unable to parse output. Exception message:" + ex.message)
            throw ex
        } catch(IOException ex){
            log.error("Unable to get response, most probably due to incorrect NIP. Please verify it before retrying. Exception message:" + ex.message)
            throw ex
        } catch (Exception ex){
            log.error("Unable to verify NIP due to unexpected exception. Exception message:" + ex.message, ex)
            throw ex
        }
    }

}
